<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Symulator Fazy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Press Start 2P', cursive; /* Retro czcionka */
            user-select: none;
        }

        canvas {
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            color: #fff;
            text-shadow: 2px 2px #ff00de;
            font-size: 20px;
        }

        .sanity-bar-container {
            width: 300px;
            height: 20px;
            border: 2px solid white;
            background: #333;
            position: relative;
        }

        #sanity-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00);
            transition: width 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #00ff41;
            z-index: 10;
            pointer-events: auto;
        }

        h1 {
            font-size: 40px;
            text-align: center;
            color: #ff00de;
            text-shadow: 4px 4px #00ff41;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        button {
            background: #000;
            color: #00ff41;
            border: 4px solid #00ff41;
            padding: 20px 40px;
            font-family: inherit;
            font-size: 20px;
            cursor: pointer;
            transition: 0.1s;
            text-transform: uppercase;
            box-shadow: 0 0 15px #00ff41;
        }

        button:hover {
            background: #00ff41;
            color: #000;
            transform: scale(1.1);
        }

        /* Klasy efekt√≥w CSS dla ca≈Çego canvasu */
        .glitch-effect {
            animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="hud-top">
        <div>WYNIK: <span id="score-el">0</span></div>
        <div>
            FAZOMETR:
            <div class="sanity-bar-container">
                <div id="sanity-bar"></div>
            </div>
        </div>
    </div>
</div>

<div id="overlay">
    <h1>SYMULATOR FAZY<br><span style="font-size:0.5em; color:white;">NARKOTYKI MACHEN</span></h1>
    <p style="color: #aaa; margin-bottom: 30px; text-align: center;">Steruj myszkƒÖ. ≈Åap fazƒô i kebaby. Unikaj Urzƒôdu Skarbowego i psiarni.</p>
    <button id="start-btn">START</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    /** KONFIGURACJA **/
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-el');
    const sanityBar = document.getElementById('sanity-bar');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('start-btn');
    const titleText = overlay.querySelector('h1');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Stan gry
    let gameActive = false;
    let score = 0;
    let sanity = 100;
    let tripIntensity = 0; // 0 do 1
    let frame = 0;
    let shakeDuration = 0;

    // --- SYSTEM AUDIO (SYNTEZATOR) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        
        if (type === 'good') {
            // Radosne "Ding!"
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'bad') {
            // Bolesne "Bzzzt"
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.2);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
            osc.start(now);
            osc.stop(now + 0.2);
        } else if (type === 'kebab') {
            // Anielski ch√≥r (w przybli≈ºeniu)
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.5);
            gain.gain.setValueAtTime(0.5, now);
            gain.gain.linearRampToValueAtTime(0.01, now + 0.8);
            osc.start(now);
            osc.stop(now + 0.8);
        }
    }

    // --- GRACZ ---
    const player = {
        x: canvas.width / 2,
        y: canvas.height - 100,
        size: 50,
        trail: [],
        emoji: "üòµ‚Äçüí´",
        update: function() {
            // ≈ölad (trail)
            if (frame % 3 === 0) {
                this.trail.push({x: this.x, y: this.y, alpha: 1.0});
            }
            if (this.trail.length > 10) this.trail.shift();
        },
        draw: function() {
            // Rysowanie ≈õladu
            this.trail.forEach((t, i) => {
                t.alpha -= 0.05;
                ctx.globalAlpha = Math.max(0, t.alpha * 0.5);
                ctx.font = (this.size - 10) + "px Arial";
                ctx.fillText(this.emoji, t.x, t.y);
            });
            ctx.globalAlpha = 1;

            // Rysowanie gracza
            ctx.save();
            ctx.translate(this.x, this.y);
            // Rotacja przy fazie
            if (tripIntensity > 0.5) {
                ctx.rotate(Math.sin(frame * 0.1) * 0.5);
            }
            ctx.font = this.size + "px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowColor = "#00ff41";
            ctx.shadowBlur = 20;
            ctx.fillText(this.emoji, 0, 0);
            ctx.restore();
        }
    };

    // --- CZƒÑSTECZKI (PARTICLES) ---
    let particles = [];
    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 0.5) * 10;
            this.life = 1.0;
            this.color = color;
            this.size = Math.random() * 8 + 2;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= 0.03;
        }
        draw() {
            ctx.globalAlpha = Math.max(0, this.life);
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size);
            ctx.globalAlpha = 1;
        }
    }

    function spawnParticles(x, y, color) {
        for(let i=0; i<15; i++) {
            particles.push(new Particle(x, y, color));
        }
    }

    // --- PRZEDMIOTY ---
    let items = [];
    const itemTypes = [
        { type: 'good', emoji: 'üçÑ', score: 50, sanity: 5, color: '#ff00de', chance: 0.6 }, // Grzybek
        { type: 'good', emoji: 'üíä', score: 100, sanity: 10, color: '#00ffff', chance: 0.3 }, // Pigu≈Ça
        { type: 'kebab', emoji: 'ü•ô', score: 500, sanity: 50, color: '#ffaa00', chance: 0.05 }, // KEBAB
        { type: 'bad', emoji: 'üöî', score: -50, sanity: -20, color: '#ff0000', chance: 0.3 }, // Policja
        { type: 'bad', emoji: 'üìÑ', score: 0, sanity: -30, color: '#ffffff', chance: 0.2 } // Pismo z Urzƒôdu
    ];

    class Item {
        constructor() {
            // Losowanie typu na podstawie wagi (chance)
            // Uproszczone losowanie
            const rand = Math.random();
            if (rand < 0.1) this.data = itemTypes[2]; // Kebab (rzadki)
            else if (rand < 0.4) this.data = itemTypes[3]; // Policja
            else if (rand < 0.5) this.data = itemTypes[4]; // UrzƒÖd
            else this.data = rand < 0.75 ? itemTypes[0] : itemTypes[1]; // Grzyby/Pigu≈Çy

            this.x = Math.random() * (canvas.width - 50);
            this.y = -50;
            this.size = 40;
            this.speed = 3 + Math.random() * 2 + (score / 1000); // Przyspiesza z czasem
            this.angle = 0;
        }
        update() {
            this.y += this.speed;
            this.angle += 0.05;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(Math.sin(this.angle) * 0.5);
            ctx.font = this.size + "px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.data.emoji, 0, 0);
            ctx.restore();
        }
    }

    // --- G≈Å√ìWNA PƒòTLA ---
    
    function resetGame() {
        score = 0;
        sanity = 100;
        items = [];
        particles = [];
        tripIntensity = 0;
        scoreEl.innerText = "0";
        sanityBar.style.width = "100%";
        player.x = canvas.width / 2;
        gameActive = true;
        canvas.classList.remove('glitch-effect');
        initAudio();
        animate();
    }

    function gameOver() {
        gameActive = false;
        overlay.style.display = 'flex';
        titleText.innerHTML = `GAME OVER<br><span style="font-size:0.5em; color:white;">WYNIK: ${score}</span>`;
        startBtn.innerText = "SPR√ìBUJ JESZCZE RAZ";
    }

    function animate() {
        if (!gameActive) return;
        frame++;

        // 1. T≈Ço i efekty wizualne
        // Czy≈õcimy ekran z lekkim przezroczystym "fade", ≈ºeby robiƒá smugi
        ctx.fillStyle = `rgba(10, 10, 10, ${tripIntensity > 0.5 ? 0.3 : 0.8})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Shake screen logic
        ctx.save();
        if (shakeDuration > 0) {
            const dx = (Math.random() - 0.5) * 20;
            const dy = (Math.random() - 0.5) * 20;
            ctx.translate(dx, dy);
            shakeDuration--;
        }

        // T≈Ço psychodeliczne przy wysokim tripie
        if (tripIntensity > 0.8) {
            ctx.globalCompositeOperation = 'lighter'; // Tryb mieszania kolor√≥w
        }

        // 2. Logika Gracza
        player.update();
        player.draw();

        // 3. Spawnowanie przedmiot√≥w
        if (frame % Math.max(20, 60 - Math.floor(score/100)) === 0) {
            items.push(new Item());
        }

        // 4. Obs≈Çuga przedmiot√≥w
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.update();
            item.draw();

            // Kolizja
            const dist = Math.hypot(player.x - item.x, player.y - item.y);
            if (dist < player.size/1.5 + item.size/1.5) {
                // TRAFIENIE!
                if (item.data.type === 'bad') {
                    sanity += item.data.sanity;
                    tripIntensity = Math.max(0, tripIntensity - 0.2); // Z≈Çe rzeczy otrze≈∫wiajƒÖ brutalnie
                    shakeDuration = 10; // Trzƒôsienie
                    playSound('bad');
                    spawnParticles(item.x, item.y, '#ff0000');
                } else {
                    score += item.data.score;
                    sanity = Math.min(100, sanity + item.data.sanity);
                    
                    if (item.data.type === 'kebab') {
                         playSound('kebab');
                         tripIntensity = 0.2; // Kebab stabilizuje fazƒô
                         spawnParticles(item.x, item.y, '#ffd700');
                    } else {
                         playSound('good');
                         tripIntensity = Math.min(1, tripIntensity + 0.1);
                         spawnParticles(item.x, item.y, item.data.color);
                    }
                }
                
                items.splice(i, 1);
            } else if (item.y > canvas.height + 50) {
                items.splice(i, 1);
            }
        }

        // 5. CzƒÖsteczki
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.update();
            p.draw();
            if (p.life <= 0) particles.splice(i, 1);
        }

        ctx.restore();

        // 6. UI i Trip Update
        scoreEl.innerText = score;
        sanityBar.style.width = Math.max(0, sanity) + "%";

        // Filtry CSS w zale≈ºno≈õci od fazy
        if (tripIntensity > 0.8) {
            canvas.style.filter = `hue-rotate(${frame*2}deg) contrast(150%)`;
            player.emoji = "ü§Ø";
        } else if (tripIntensity > 0.4) {
            canvas.style.filter = `hue-rotate(${frame}deg) saturate(200%)`;
            player.emoji = "ü•¥";
        } else {
            canvas.style.filter = "none";
            player.emoji = "üòµ‚Äçüí´";
        }

        // Game Over Check
        if (sanity <= 0) {
            gameOver();
        } else {
            requestAnimationFrame(animate);
        }
    }

    // --- STEROWANIE ---
    window.addEventListener('mousemove', e => {
        if(gameActive) player.x = e.clientX;
    });
    
    window.addEventListener('touchmove', e => {
        e.preventDefault();
        if(gameActive) player.x = e.touches[0].clientX;
    }, {passive: false});

    startBtn.addEventListener('click', () => {
        overlay.style.display = 'none';
        resetGame();
    });

    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.y = canvas.height - 100;
    });

</script>
</body>
</html>